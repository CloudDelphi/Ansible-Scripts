########################################################################
# MDA configuration
#
# {{ ansible_managed }}
# Do NOT edit this file directly!

smtpd_banner     = $myhostname ESMTP $mail_name (Debian/GNU)
biff             = no
readme_directory = no
mail_owner       = postfix

delay_warning_time     = 4h
maximal_queue_lifetime = 5d

myorigin            = /etc/mailname
myhostname          = mda{{ imapno | default('') }}.$mydomain
mydomain            = fripost.org
append_dot_mydomain = no

# Turn off all TCP/IP listener ports except that necessary for the MDA.
master_service_disable = !2526.inet inet

queue_directory       = /var/spool/postfix-{{ postfix_instance[inst].name }}
data_directory        = /var/lib/postfix-{{ postfix_instance[inst].name }}
multi_instance_group  = {{ postfix_instance[inst].group | default('') }}
multi_instance_name   = postfix-{{ postfix_instance[inst].name }}
multi_instance_enable = yes

# This server is a Mail Delivery Agent
mynetworks_style = host
inet_interfaces  = all


# No local delivery
mydestination        =
local_transport      = error:5.1.1 Mailbox unavailable
alias_maps           =
alias_database       =
local_recipient_maps =

message_size_limit  = 67108864
recipient_delimiter = +

# No relay: this server is inbound-only
relay_transport   = error:5.1.1 Relay unavailable
default_transport = error:5.1.1 Transport unavailable

# Virtual transport (the alias resolution and address validation is
# performed on the MX:es only)
virtual_transport       = lmtp:unix:private/dovecot-lmtpd
lmtp_bind_address       = 127.0.0.1
virtual_mailbox_domains = static:all
virtual_mailbox_maps    = static:all
#transport_maps          = cdb:$config_directory/transport

# Restore the original envelope recipient
relay_domains               =
recipient_canonical_classes = envelope_recipient
recipient_canonical_maps    = pcre:$config_directory/recipient_canonical.pcre

# Don't rewrite remote headers
local_header_rewrite_clients =


relay_clientcerts               = cdb:$config_directory/relay_clientcerts
smtpd_tls_security_level        = may
smtpd_tls_exclude_ciphers       = EXPORT, LOW, MEDIUM, aNULL, eNULL, DES, RC4, MD5
smtpd_tls_cert_file             = /etc/postfix/ssl/{{ ansible_fqdn }}.pem
smtpd_tls_key_file              = /etc/postfix/ssl/{{ ansible_fqdn }}.key
smtpd_tls_dh1024_param_file     = /etc/ssl/private/dhparams.pem
smtpd_tls_session_cache_database= btree:$data_directory/smtpd_tls_session_cache
smtpd_tls_received_header       = yes
smtpd_tls_ask_ccert             = yes
smtpd_tls_session_cache_timeout = 3600s
smtpd_tls_fingerprint_digest    = sha256


strict_rfc821_envelopes = yes
smtpd_delay_reject      = yes
disable_vrfy_command    = yes

smtpd_client_restrictions =
    permit_mynetworks
    permit_tls_clientcerts
    # We are the only ones using this proxy, but if things go wrong we
    # want to know why
    defer

smtpd_helo_required     = yes
smtpd_helo_restrictions =
    reject_invalid_helo_hostname

smtpd_sender_restrictions =
    reject_non_fqdn_sender

smtpd_relay_restrictions =
    permit_mynetworks
    permit_tls_clientcerts
    reject

smtpd_recipient_restrictions =
    reject_non_fqdn_recipient

smtpd_data_restrictions =
    reject_unauth_pipelining

# vim: set filetype=pfmain :
